# 数据库自动迁移说明

## 功能概述

应用现在支持**自动数据库初始化**，在应用启动时会自动检查并创建/更新数据库表结构，无需手动执行 SQL 脚本。

## 工作原理

1. **启动时检查**：应用启动时自动执行 `scripts/init-db.js`
2. **智能判断**：
   - 如果表不存在 → 自动创建表结构
   - 如果表已存在 → 检查版本号，判断是否需要更新
3. **版本管理**：使用 `schema_version` 表记录数据库结构版本

## 使用方法

### 自动执行（推荐）

**无需任何操作**，应用启动时会自动执行：

```bash
# 正常启动应用即可
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d app
```

启动日志会显示：
```
========================================
数据库自动初始化
========================================
数据库主机: mysql:3306
数据库用户: root
数据库名称: yuwen_cuoti7225
========================================
✅ MySQL 连接成功
✅ 数据库 yuwen_cuoti7225 已就绪
📝 表 word_entries 不存在，开始创建...
✅ 表 word_entries 创建成功
✅ 已记录数据库结构版本 v1
========================================
✅ 数据库初始化完成！
========================================
```

### 手动执行（可选）

如果需要手动执行初始化：

```bash
# 在服务器上
docker exec yuwen-app node scripts/init-db.js
```

## 表结构版本管理

### 当前版本

在 `scripts/init-db.js` 中定义：

```javascript
const SCHEMA_VERSION = 1;
```

### 如何更新表结构

当需要修改表结构时：

1. **修改 `database/schema.sql`**：更新表结构定义

2. **更新版本号**：在 `scripts/init-db.js` 中增加版本号：
   ```javascript
   const SCHEMA_VERSION = 2;  // 从 1 改为 2
   ```

3. **添加迁移逻辑**（可选）：在 `scripts/init-db.js` 中添加迁移代码：
   ```javascript
   if (currentVersion < SCHEMA_VERSION) {
     // 执行迁移 SQL
     await connection.query('ALTER TABLE word_entries ADD COLUMN new_field VARCHAR(255)');
     await connection.query('INSERT INTO schema_version (version) VALUES (?)', [SCHEMA_VERSION]);
   }
   ```

4. **重新部署**：重新构建并启动应用，会自动执行迁移

### 迁移示例

假设要添加一个新字段 `notes`：

```javascript
// 在 scripts/init-db.js 中
const SCHEMA_VERSION = 2;

// 在版本检查后添加迁移逻辑
if (currentVersion === 1 && SCHEMA_VERSION === 2) {
  console.log('执行迁移：v1 -> v2');
  await connection.query(`
    ALTER TABLE word_entries 
    ADD COLUMN notes TEXT NULL 
    AFTER previous_test_status
  `);
  await connection.query('INSERT INTO schema_version (version) VALUES (2)', [2]);
  console.log('✅ 迁移完成：v1 -> v2');
}
```

## 配置文件

### 环境变量

初始化脚本会从环境变量读取配置：

- `DB_HOST` 或 `MYSQL_HOST`：数据库主机（默认：localhost）
- `DB_USER` 或 `MYSQL_USER`：数据库用户（默认：root）
- `DB_PASSWORD` 或 `MYSQL_ROOT_PASSWORD`：数据库密码
- `DB_NAME` 或 `MYSQL_DATABASE`：数据库名称（默认：yuwen_cuoti）
- `DB_PORT` 或 `MYSQL_PORT`：数据库端口（默认：3306）

这些环境变量已在 `docker-compose.prod.yml` 中配置，无需额外设置。

## 故障排查

### 如果初始化失败

1. **检查日志**：
   ```bash
   docker logs yuwen-app | grep -A 20 "数据库自动初始化"
   ```

2. **检查数据库连接**：
   ```bash
   docker exec yuwen-app node -e "
     import('./scripts/init-db.js').then(m => m.default()).catch(console.error);
   "
   ```

3. **手动执行**：
   ```bash
   docker exec yuwen-app node scripts/init-db.js
   ```

### 如果表已存在但版本不匹配

系统会提示需要手动迁移：

```
⚠️  数据库结构版本为 v1，需要升级到 v2
⚠️  请手动执行迁移脚本或更新表结构
```

此时需要：
1. 手动执行迁移 SQL
2. 或更新 `schema_version` 表中的版本号

## 优势

✅ **自动化**：无需手动执行 SQL 脚本  
✅ **版本管理**：自动跟踪数据库结构版本  
✅ **安全性**：不会重复创建已存在的表  
✅ **灵活性**：支持手动执行和自动执行  
✅ **容错性**：初始化失败不会阻止应用启动  

## 注意事项

1. **首次部署**：如果数据库完全为空，会自动创建表和数据库
2. **数据安全**：自动初始化不会删除现有数据，只会创建不存在的表
3. **版本升级**：需要手动添加迁移逻辑（未来可以集成 Flyway 等工具）
4. **权限要求**：需要数据库用户有 CREATE DATABASE 和 CREATE TABLE 权限

## 相关文件

- `scripts/init-db.js` - 自动初始化脚本
- `database/schema.sql` - 数据库表结构定义
- `server.js` - 应用启动文件（调用初始化脚本）
- `故障排查.md` - 故障排查指南

