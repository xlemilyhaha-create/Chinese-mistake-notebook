# 小内存服务器 MySQL 优化指南

如果服务器内存较小（如 1GB 或更少），MySQL 可能无法正常启动。本文档提供针对小内存服务器的优化配置。

## 问题症状

- MySQL 容器不断重启
- 日志显示 "InnoDB initialization has started" 但无法完成
- 日志显示 MySQL 只能访问少量内存（如 256MB）

## 优化配置

### 1. 修改 env.prod 文件

```bash
# MySQL 内存配置（小内存服务器）
MYSQL_BUFFER_POOL_SIZE=64M
MYSQL_MEMORY_LIMIT=512M
MYSQL_MEMORY_RESERVATION=256M
```

### 2. 服务器内存建议

| 服务器总内存 | MYSQL_BUFFER_POOL_SIZE | MYSQL_MEMORY_LIMIT | MYSQL_MEMORY_RESERVATION |
|------------|----------------------|-------------------|------------------------|
| 512MB | 64M | 256M | 128M |
| 1GB | 128M | 512M | 256M |
| 2GB | 256M | 1G | 512M |
| 4GB+ | 512M+ | 2G+ | 1G+ |

### 3. 如果仍然无法启动

#### 方案 A: 清理数据目录重新初始化

```bash
# 1. 停止所有容器
docker-compose -f docker-compose.prod.yml --env-file .env.prod down

# 2. 备份数据目录（如果有重要数据）
mv ${MYSQL_DATA_DIR} ${MYSQL_DATA_DIR}.backup

# 3. 重新创建数据目录
mkdir -p ${MYSQL_DATA_DIR}
chmod 755 ${MYSQL_DATA_DIR}

# 4. 重新启动
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d mysql

# 5. 等待 MySQL 完全启动（可能需要几分钟）
docker logs -f yuwen-mysql
```

#### 方案 B: 进一步降低内存配置

如果服务器内存非常小（如 256MB），可以进一步优化：

```bash
# 在 env.prod 中设置
MYSQL_BUFFER_POOL_SIZE=32M
MYSQL_MEMORY_LIMIT=256M
MYSQL_MEMORY_RESERVATION=128M
```

并在 `docker-compose.prod.yml` 中修改 MySQL 命令参数：

```yaml
command: 
  - --character-set-server=utf8mb4
  - --collation-server=utf8mb4_unicode_ci
  - --max_connections=30
  - --innodb_buffer_pool_size=32M
  - --innodb_flush_log_at_trx_commit=2
  - --key_buffer_size=8M
  - --tmp_table_size=16M
  - --max_heap_table_size=16M
```

## 验证配置

### 检查 MySQL 内存使用

```bash
# 查看容器内存使用
docker stats yuwen-mysql

# 进入 MySQL 查看配置
docker exec -it yuwen-mysql mysql -u root -p
# 执行：
SHOW VARIABLES LIKE 'innodb_buffer_pool_size';
SHOW VARIABLES LIKE 'max_connections';
```

### 检查服务器可用内存

```bash
# 查看系统内存
free -h

# 查看 Docker 容器内存使用
docker stats --no-stream
```

## 性能权衡

降低内存配置会影响性能：

- ✅ **优点**：可以在小内存服务器上运行
- ⚠️ **缺点**：
  - 查询性能可能较慢
  - 并发连接数受限
  - 不适合大量数据

## 建议

对于生产环境，建议：

1. **最小配置**：1GB 内存服务器
2. **推荐配置**：2GB+ 内存服务器
3. **如果必须使用小内存服务器**：
   - 定期清理不必要的数据
   - 限制并发连接数
   - 考虑使用更轻量的数据库（如 SQLite，但功能受限）

## 相关文档

- [故障排查指南](./故障排查.md)
- [Docker 部署指南](./DOCKER.md)

