# 阿里云 ECS 安全组配置指南

本文档说明如何在阿里云 ECS 上配置安全组规则，以安全地部署语文错题助手应用。

## 端口说明

根据当前配置：

| 服务 | 端口 | 说明 | 是否需要对外开放 |
|------|------|------|----------------|
| 应用服务 | 3001 | Web 应用端口 | ✅ 是（HTTP） |
| MySQL | 3307 | 数据库端口 | ❌ 否（已配置为仅本地访问） |

## 安全组配置步骤

### 1. 登录阿里云控制台

1. 访问 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 进入 **云服务器 ECS** > **实例**
3. 找到你的 ECS 实例，点击实例 ID 进入详情页

### 2. 配置安全组规则

#### 方法一：通过 ECS 实例页面配置（推荐）

1. 在实例详情页，找到 **安全组** 标签
2. 点击安全组 ID 进入安全组规则页面
3. 点击 **添加安全组规则**

#### 方法二：通过安全组页面配置

1. 进入 **网络与安全** > **安全组**
2. 找到你的 ECS 实例绑定的安全组
3. 点击 **配置规则** > **入方向** > **添加安全组规则**

### 3. 添加应用端口规则（必需）

#### HTTP 访问（开发/测试环境）

| 配置项 | 值 |
|--------|-----|
| **规则方向** | 入方向 |
| **授权策略** | 允许 |
| **优先级** | 1（数字越小优先级越高） |
| **协议类型** | 自定义 TCP |
| **端口范围** | 3001/3001 |
| **授权对象** | 0.0.0.0/0（允许所有 IP）或指定 IP 段 |
| **描述** | 语文错题助手应用端口 |

**⚠️ 安全建议**：
- 如果只是临时测试，建议将 **授权对象** 设置为你的公网 IP 或 IP 段，而不是 `0.0.0.0/0`
- 生产环境建议使用 HTTPS（见下方 HTTPS 配置）

#### HTTPS 访问（生产环境推荐）

如果使用 Nginx 反向代理并配置了 HTTPS（端口 443）：

| 配置项 | 值 |
|--------|-----|
| **规则方向** | 入方向 |
| **授权策略** | 允许 |
| **优先级** | 1 |
| **协议类型** | HTTPS (443) |
| **端口范围** | 443/443 |
| **授权对象** | 0.0.0.0/0 |
| **描述** | HTTPS 访问端口 |

### 4. SSH 访问规则（管理服务器用）

如果需要通过 SSH 管理服务器：

| 配置项 | 值 |
|--------|-----|
| **规则方向** | 入方向 |
| **授权策略** | 允许 |
| **优先级** | 1 |
| **协议类型** | SSH (22) |
| **端口范围** | 22/22 |
| **授权对象** | 你的公网 IP 或 IP 段（**强烈建议不要设置为 0.0.0.0/0**） |
| **描述** | SSH 管理端口 |

### 5. 其他常用端口（可选）

#### ICMP（Ping 测试）

| 配置项 | 值 |
|--------|-----|
| **规则方向** | 入方向 |
| **授权策略** | 允许 |
| **优先级** | 100 |
| **协议类型** | ICMP |
| **授权对象** | 0.0.0.0/0 |
| **描述** | Ping 测试 |

## 安全建议

### ✅ 必须配置

1. **应用端口（3001）**：允许 HTTP 访问
2. **SSH 端口（22）**：仅允许你的 IP 访问

### ⚠️ 强烈建议

1. **使用 HTTPS**：
   - 配置 Nginx 反向代理
   - 使用 Let's Encrypt 免费 SSL 证书
   - 开放 443 端口，关闭 3001 端口对外访问

2. **限制 IP 访问**：
   - 如果可能，将应用端口（3001）的授权对象设置为特定 IP 段
   - SSH 端口（22）必须限制为你的 IP

3. **定期更新密码**：
   - 数据库密码
   - 系统用户密码

### ❌ 不要配置

1. **MySQL 端口（3307）**：
   - ❌ **不要**在安全组中开放 3307 端口
   - ✅ 已在 `docker-compose.prod.yml` 中配置为仅本地访问（`127.0.0.1:3307`）

2. **其他不必要的端口**：
   - 不要开放未使用的端口
   - 遵循最小权限原则

## 完整安全组规则示例

### 最小化配置（推荐）

| 规则名称 | 方向 | 协议 | 端口 | 授权对象 | 优先级 | 说明 |
|---------|------|------|------|---------|--------|------|
| HTTP-3001 | 入方向 | TCP | 3001 | 0.0.0.0/0 | 1 | 应用访问 |
| SSH | 入方向 | TCP | 22 | 你的IP/32 | 1 | SSH 管理 |
| ICMP | 入方向 | ICMP | -1/-1 | 0.0.0.0/0 | 100 | Ping 测试 |

### 生产环境配置（使用 HTTPS）

| 规则名称 | 方向 | 协议 | 端口 | 授权对象 | 优先级 | 说明 |
|---------|------|------|------|---------|--------|------|
| HTTPS-443 | 入方向 | TCP | 443 | 0.0.0.0/0 | 1 | HTTPS 访问 |
| SSH | 入方向 | TCP | 22 | 你的IP/32 | 1 | SSH 管理 |
| ICMP | 入方向 | ICMP | -1/-1 | 0.0.0.0/0 | 100 | Ping 测试 |

**注意**：如果使用 Nginx 反向代理，应用端口 3001 不需要对外开放。

## 验证配置

### 1. 检查安全组规则

```bash
# 在 ECS 实例上查看当前开放的端口
sudo netstat -tlnp | grep LISTEN
```

### 2. 测试端口访问

```bash
# 从本地测试应用端口是否可访问
curl http://你的ECS公网IP:3001

# 测试 HTTPS（如果配置了）
curl https://你的域名
```

### 3. 检查 MySQL 端口

```bash
# MySQL 端口应该只监听本地，不应该对外暴露
sudo netstat -tlnp | grep 3307
# 应该显示：127.0.0.1:3307，而不是 0.0.0.0:3307
```

## 常见问题

### Q1: 配置了安全组规则，但无法访问应用？

**检查清单**：
1. ✅ 安全组规则已保存
2. ✅ ECS 实例已绑定该安全组
3. ✅ 应用容器正在运行：`docker ps`
4. ✅ 应用日志无错误：`docker logs yuwen-app`
5. ✅ 防火墙（iptables/firewalld）未阻止端口

### Q2: 如何查看当前安全组规则？

1. 在阿里云控制台：ECS > 实例 > 安全组 > 配置规则
2. 在 ECS 上：`sudo iptables -L -n`（如果使用 iptables）

### Q3: 如何临时关闭某个端口？

在安全组规则中，将对应规则的 **授权策略** 改为 **拒绝**，或直接删除该规则。

### Q4: 使用 Nginx 反向代理后，还需要开放 3001 端口吗？

**不需要**。如果使用 Nginx 反向代理：
- 只需要开放 80（HTTP）和 443（HTTPS）端口
- 应用端口 3001 可以只监听本地（127.0.0.1）
- 在 `docker-compose.prod.yml` 中修改应用端口映射为：`"127.0.0.1:3001:3000"`

## 防火墙配置（ECS 系统层面）

除了安全组，还需要检查 ECS 系统防火墙：

### CentOS/RHEL

```bash
# 检查 firewalld 状态
sudo systemctl status firewalld

# 如果 firewalld 运行，添加端口（如果需要）
sudo firewall-cmd --permanent --add-port=3001/tcp
sudo firewall-cmd --reload
```

### Ubuntu/Debian

```bash
# 检查 ufw 状态
sudo ufw status

# 如果需要，添加端口（但通常安全组已足够）
sudo ufw allow 3001/tcp
```

**注意**：如果使用 Docker，通常不需要在系统防火墙中配置，安全组规则已足够。

## 相关文档

- [阿里云安全组文档](https://help.aliyun.com/document_detail/25471.html)
- [DOCKER.md](./DOCKER.md) - Docker 部署详细说明
- [更新说明.md](./更新说明.md) - 版本更新记录

