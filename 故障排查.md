# 故障排查指南

本文档提供常见问题的排查和解决方法。

## MySQL 容器健康检查失败

### 错误信息
```
dependency failed to start: container yuwen-mysql is unhealthy
```

### 排查步骤

#### 1. 查看 MySQL 容器日志

```bash
# 查看 MySQL 容器日志
docker logs yuwen-mysql

# 实时查看日志
docker logs -f yuwen-mysql
```

#### 2. 检查容器状态

```bash
# 查看容器状态
docker ps -a | grep mysql

# 查看容器详细信息
docker inspect yuwen-mysql | grep -A 10 Health
```

#### 3. 常见原因和解决方法

##### 原因 1: MySQL 启动时间过长

**症状**：日志显示 MySQL 正在初始化，但健康检查超时

**解决方法**：
- 健康检查已配置 `start_period: 30s`，给 MySQL 30 秒启动时间
- 如果服务器性能较低，可以增加 `start_period` 值

##### 原因 2: 内存不足

**症状**：日志显示内存相关错误

**解决方法**：
- 检查 `env.prod` 中的内存配置
- 确保 `MYSQL_MEMORY_LIMIT` 和 `MYSQL_BUFFER_POOL_SIZE` 设置合理
- 对于小内存服务器（如 1GB），建议：
  ```bash
  MYSQL_BUFFER_POOL_SIZE=128M
  MYSQL_MEMORY_LIMIT=256M
  MYSQL_MEMORY_RESERVATION=128M
  ```

##### 原因 3: 数据目录权限问题

**症状**：日志显示权限错误

**解决方法**：
```bash
# 检查数据目录权限
ls -la ${MYSQL_DATA_DIR}

# 修复权限（如果需要）
sudo chown -R 999:999 ${MYSQL_DATA_DIR}
```

##### 原因 4: 数据目录已存在但版本不兼容

**症状**：日志显示数据目录不可用

**解决方法**：
```bash
# 备份旧数据（如果需要）
mv ${MYSQL_DATA_DIR} ${MYSQL_DATA_DIR}.backup

# 重新创建数据目录
mkdir -p ${MYSQL_DATA_DIR}
chmod 755 ${MYSQL_DATA_DIR}
```

##### 原因 5: 健康检查命令失败

**症状**：容器运行但健康检查一直失败

**解决方法**：
```bash
# 手动测试健康检查命令
docker exec yuwen-mysql mysqladmin ping -h localhost -u root -p你的密码

# 如果失败，检查密码是否正确
```

#### 4. 临时解决方案

如果健康检查一直失败，可以临时修改 `depends_on` 配置：

```yaml
# 在 docker-compose.prod.yml 中，将
depends_on:
  mysql:
    condition: service_healthy

# 改为
depends_on:
  mysql:
    condition: service_started
```

**注意**：这只是临时方案，建议修复健康检查问题后再改回 `service_healthy`。

### 手动启动 MySQL 容器

```bash
# 只启动 MySQL 容器（不启动应用）
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d mysql

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f mysql

# 等待 MySQL 完全启动后，再启动应用
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d app
```

## 应用无法连接数据库

### 错误信息
```
ECONNREFUSED
ER_ACCESS_DENIED_ERROR
```

### 排查步骤

#### 1. 检查数据库服务状态

```bash
docker ps | grep mysql
```

#### 2. 检查环境变量

```bash
# 检查应用容器的环境变量
docker exec yuwen-app env | grep DB_

# 应该显示：
# DB_HOST=mysql
# DB_USER=yuwen_user
# DB_PASSWORD=你的密码
# DB_NAME=yuwen_cuoti
```

#### 3. 测试数据库连接

```bash
# 从应用容器测试连接
docker exec yuwen-app sh -c "apk add --no-cache mysql-client && mysql -h mysql -u yuwen_user -p你的密码 yuwen_cuoti -e 'SELECT 1'"
```

#### 4. 检查网络连接

```bash
# 检查应用容器能否访问 MySQL 容器
docker exec yuwen-app ping -c 3 mysql
```

## 端口冲突

### 错误信息
```
Bind for 0.0.0.0:3001 failed: port is already allocated
```

### 解决方法

```bash
# 查找占用端口的进程
sudo lsof -i :3001
# 或
sudo netstat -tlnp | grep 3001

# 停止占用端口的服务，或修改 env.prod 中的 APP_PORT
```

## 构建失败

### 错误信息
```
npm ci failed
```

### 解决方法

```bash
# 清理构建缓存
docker builder prune -f

# 不使用缓存重新构建
docker-compose -f docker-compose.prod.yml --env-file .env.prod build --no-cache app
```

## 查看日志

### 应用日志

```bash
# 查看应用日志
docker logs yuwen-app

# 实时查看
docker logs -f yuwen-app

# 查看最近 100 行
docker logs --tail 100 yuwen-app
```

### MySQL 日志

```bash
# 查看 MySQL 日志
docker logs yuwen-mysql

# 实时查看
docker logs -f yuwen-mysql

# 查看错误日志
docker exec yuwen-mysql cat /var/log/mysql/error.log
```

### 所有服务日志

```bash
# 查看所有服务日志
docker-compose -f docker-compose.prod.yml --env-file .env.prod logs

# 实时查看
docker-compose -f docker-compose.prod.yml --env-file .env.prod logs -f
```

## 重置环境

### 完全重置（⚠️ 会删除所有数据）

```bash
# 停止并删除所有容器和数据卷
docker-compose -f docker-compose.prod.yml --env-file .env.prod down -v

# 清理数据目录（如果需要）
rm -rf ${MYSQL_DATA_DIR}

# 重新创建并启动
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d --build
```

### 仅重置应用（保留数据库）

```bash
# 停止应用容器
docker-compose -f docker-compose.prod.yml --env-file .env.prod stop app

# 删除应用容器
docker-compose -f docker-compose.prod.yml --env-file .env.prod rm -f app

# 重新构建并启动应用
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d --build app
```

## 性能问题

### MySQL 响应慢

1. **检查内存配置**：
   ```bash
   # 查看 MySQL 内存使用
   docker stats yuwen-mysql
   ```

2. **优化配置**：
   - 增加 `MYSQL_BUFFER_POOL_SIZE`
   - 增加 `MYSQL_MEMORY_LIMIT`

3. **检查慢查询**：
   ```bash
   docker exec yuwen-mysql mysql -u root -p -e "SHOW VARIABLES LIKE 'slow_query_log%';"
   ```

### 应用响应慢

1. **检查应用日志**：查看是否有错误或警告
2. **检查数据库连接**：确保连接池配置合理
3. **检查 AI API**：AI 模型调用可能较慢

## 联系支持

如果以上方法都无法解决问题，请提供以下信息：

1. 错误日志（`docker logs yuwen-mysql` 和 `docker logs yuwen-app`）
2. 容器状态（`docker ps -a`）
3. 环境配置（`.env.prod` 文件，隐藏敏感信息）
4. 服务器配置（内存、CPU、操作系统）

