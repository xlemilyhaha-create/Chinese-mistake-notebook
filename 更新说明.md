# 功能更新说明

本文档记录了应用的所有功能更新内容。

## 目录

1. [测试状态跟踪与筛选功能](#1-测试状态跟踪与筛选功能)
2. [多模型支持](#2-多模型支持)
3. [Docker 支持](#3-docker-支持)

---

## 1. 测试状态跟踪与筛选功能

### 更新内容

本次更新为应用添加了测试状态跟踪和筛选功能：

#### 1.1 测试通过状态
- 每个词条新增 `testStatus` 字段，包含三个状态：
  - `NOT_TESTED`（未测试）：新增词条的默认状态
  - `FAILED`（未通过）：测试未通过
  - `PASSED`（已通过）：测试通过

#### 1.2 多次测试才通过
- 每个词条新增 `isMultipleAttempts` 字段（布尔值）
- 自动判断逻辑：
  - 如果从"未测试"直接更新为"已通过"：`isMultipleAttempts = false`
  - 如果从"未通过"更新为"已通过"：`isMultipleAttempts = true`
  - 其他情况根据状态变化自动更新

#### 1.3 错题列表页过滤功能

在错题列表页新增筛选功能，支持按以下条件过滤：

- **题型过滤**：可选择多个题型（注音、书写、释义、辨析、默写、古文释义）
- **测试通过状态过滤**：可选择多个状态（未测试、未通过、已通过），支持"全部"选项
- **是否多次测试才通过过滤**：可选择"是"、"否"或"全部"

#### 1.4 智能组卷条件筛选

在试卷生成页面新增组卷条件筛选：

- **测试通过状态筛选**：支持多选（未测试、未通过、已通过），默认选择"未测试"和"未通过"
- **是否多次测试才通过筛选**：可选择"是"、"否"或"全部"

#### 1.5 批量更新状态功能

- 错题列表页支持多选词条
- 批量更新测试通过状态
- 状态转换规则：
  - 从未测试 → 未通过/已通过 ✅
  - 从未通过 → 未通过/已通过 ✅
  - 已通过 → 未通过 ✅
  - 其他转换 ❌

#### 1.6 数据库存储

##### 后端API
- 新增 `/api/words` 端点，支持：
  - `GET`: 获取词条列表（支持过滤）
  - `POST`: 创建新词条
  - `PUT`: 更新词条
  - `PATCH`: 批量更新测试状态
  - `DELETE`: 删除词条

##### 数据库
- 使用 MySQL 数据库存储数据
- 数据库表：`word_entries`
- 支持 JSON 字段存储复杂数据
- 包含索引优化查询性能

##### 数据迁移
- 从 localStorage 迁移到 MySQL
- 保留导入/导出功能用于数据备份

### 技术实现

#### 新增文件

1. `api/words.js` - 数据库API端点
2. `services/wordService.ts` - 前端API服务层
3. `database/schema.sql` - 数据库表结构
4. `database/README.md` - 数据库配置说明

#### 修改文件

1. `types.ts` - 添加新类型定义
2. `App.tsx` - 集成后端API，替换localStorage
3. `components/WordList.tsx` - 添加过滤和批量选择功能
4. `components/ExamGenerator.tsx` - 添加组卷条件筛选
5. `components/WordEntryForm.tsx` - 初始化新状态字段
6. `package.json` - 添加 mysql2 依赖

### 配置要求

#### 环境变量

需要在环境配置文件中设置：

```env
DB_HOST=your-db-host
DB_USER=your-db-user
DB_PASSWORD=your-db-password
DB_NAME=yuwen_cuoti
```

#### 数据库初始化

执行以下命令初始化数据库：

```bash
mysql -u root -p < database/schema.sql
```

详细配置说明请参考 `database/README.md`

### 使用说明

#### 测试状态管理

1. **单个词条状态更新**：
   - 点击词条卡片上的编辑按钮
   - 在编辑模式下选择测试状态
   - 保存后状态自动更新

2. **批量状态更新**：
   - 在错题列表页勾选多个词条
   - 使用顶部的"批量更新状态"下拉菜单
   - 选择目标状态进行批量更新

#### 过滤功能

1. **错题列表过滤**：
   - 点击"筛选"按钮
   - 选择过滤条件
   - 点击"确定"应用筛选，面板自动关闭
   - 列表自动更新显示符合条件的词条

2. **组卷条件筛选**：
   - 在试卷生成页面点击"组卷条件"
   - 选择筛选条件
   - 试卷内容根据条件自动更新

### 注意事项

1. **数据迁移**：首次使用需要配置数据库连接
2. **状态转换**：系统会自动验证状态转换的合法性
3. **多次测试判断**：系统会根据状态变化自动更新"多次测试才通过"字段
4. **数据备份**：建议定期使用导出功能备份数据

---

## 2. 多模型支持

### 更新内容

系统新增支持多个 AI 模型提供商：**Gemini**、**DeepSeek** 和 **Qwen**。

### 主要变更

#### 2.1 新增文件

- `services/aiProvider.js`: AI 模型提供者抽象层，统一处理不同模型的调用
- `AI_MODELS.md`: 多模型支持使用说明文档

#### 2.2 修改文件

- `api/analyze.js`: 更新为支持多模型选择
- `package.json`: 添加 `@google/generative-ai`（用于 Gemini）和 `openai` 依赖（用于 DeepSeek 和 Qwen）
- `env.dev` / `env.prod`: 添加 AI 模型相关环境变量配置
- `docker-compose.dev.yml` / `docker-compose.prod.yml`: 添加 AI 模型环境变量传递

#### 2.3 技术实现

##### 后端架构

- **抽象层设计**: 通过 `services/aiProvider.js` 统一处理不同模型的调用
- **统一 API 格式**: 所有模型统一使用 JSON Schema 格式，简化代码实现
- **自动兼容性处理**: 自动处理 JSON Schema 兼容性问题，对于不支持 `json_schema` 的模型自动回退到 `json_object` 模式

##### 模型切换方式

1. **环境变量配置**（全局默认）:
   ```bash
   AI_PROVIDER=gemini  # 或 deepseek、qwen
   GEMINI_API_KEY=your_key
   DEEPSEEK_API_KEY=your_key
   QWEN_API_KEY=your_key
   ```

2. **API 请求参数**（临时切换）:
   ```json
   {
     "type": "word",
     "text": "测试",
     "provider": "deepseek",
     "model": "deepseek-chat"
   }
   ```

### 配置步骤

#### 1. 安装新依赖

```bash
npm install
```

#### 2. 更新环境变量

编辑 `.env.dev` 或 `.env.prod` 文件，添加：

```bash
# AI 模型配置
AI_PROVIDER=gemini  # 选择默认模型：gemini、deepseek、qwen

# API Keys
GEMINI_API_KEY=your_gemini_api_key
DEEPSEEK_API_KEY=your_deepseek_api_key
QWEN_API_KEY=your_qwen_api_key  # 可选
```

#### 3. 重启服务

如果使用 Docker：

```bash
./scripts/start.sh dev  # 或 prod
```

### 兼容性说明

- ✅ **前端无需修改**: 前端代码无需任何修改，继续使用 `geminiService.ts`
- ✅ **API 接口兼容**: `/api/analyze` 接口保持向后兼容，新增可选参数

### 支持的模型

| 提供商 | 默认模型 | API 端点 | 获取 API Key |
|--------|---------|---------|------------|
| Gemini | gemini-1.5-flash | https://generativelanguage.googleapis.com/v1 | https://makersuite.google.com/app/apikey |
| DeepSeek | deepseek-chat | https://api.deepseek.com/v1 | https://platform.deepseek.com/ |
| Qwen | qwen-plus | https://dashscope.aliyuncs.com/compatible-mode/v1 | https://dashscope.console.aliyun.com/ |

### 注意事项

1. **API Key 安全**: 请妥善保管 API Key，不要提交到版本控制系统
2. **模型兼容性**: 不同模型对 JSON Schema 的支持可能不同，系统已自动处理兼容性问题
3. **费用**: 不同模型的计费方式可能不同，请参考各提供商的定价信息
4. **响应格式**: 所有模型都返回统一的 JSON 格式，确保前端兼容性

### 故障排查

#### API Key 错误
- 检查环境变量中的 API Key 是否正确配置
- 确认 API Key 是否有效且未过期

#### 模型不支持 JSON Schema
- 系统会自动回退到 JSON 模式
- 如果仍有问题，请检查模型名称是否正确

#### 请求超时
- 检查网络连接
- 确认 API 端点可访问

### 详细文档

更多详细信息请参考 `AI_MODELS.md` 文件。

---

## 3. Docker 支持

### 更新内容

应用新增 Docker 容器化部署支持，包括开发环境和生产环境的完整配置。

### 主要特性

- **多环境支持**: 支持 `dev` 和 `prod` 两套环境配置
- **MySQL 集成**: 使用 MySQL 9.5.0 版本，包含在 Docker Compose 配置中
- **端口自定义**: 默认使用非标准端口（MySQL: 3307, App: 3001）避免冲突
- **数据持久化**: MySQL 数据目录可配置，支持数据持久化

### 新增文件

- `Dockerfile`: 应用镜像构建文件
- `docker-compose.dev.yml`: 开发环境 Docker Compose 配置
- `docker-compose.prod.yml`: 生产环境 Docker Compose 配置
- `.dockerignore`: Docker 构建忽略文件
- `scripts/init-db.sh`: 数据库初始化脚本
- `scripts/start.sh`: 启动脚本
- `DOCKER.md`: Docker 部署详细文档
- `env.dev`: 开发环境变量示例
- `env.prod`: 生产环境变量示例

### 配置说明

#### 环境变量文件

- `env.dev`: 开发环境配置（MySQL 端口 3307，App 端口 3001）
- `env.prod`: 生产环境配置（MySQL 端口 3307，App 端口 3001）

#### 端口配置

- **MySQL**: 3307（避免与本地 MySQL 3306 端口冲突）
- **应用**: 3001（避免与本地其他应用冲突）

#### 启动方式

```bash
# 开发环境
./scripts/start.sh dev

# 生产环境
./scripts/start.sh prod
```

### 使用说明

详细的使用说明请参考 `DOCKER.md` 文件。

---

## 后续优化建议

- [ ] 添加状态变更历史记录
- [ ] 支持更复杂的状态转换规则
- [ ] 添加统计分析功能
- [ ] 优化数据库查询性能
- [ ] 添加数据同步功能
- [ ] 支持更多 AI 模型提供商
- [ ] 优化 Docker 镜像大小
- [ ] 添加健康检查端点
